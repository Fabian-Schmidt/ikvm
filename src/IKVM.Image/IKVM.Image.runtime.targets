<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <PropertyGroup>
        <SupportedImageTargetFrameworks Condition=" '$(SupportedImageTargetFrameworks)' == '' ">$(TargetFrameworks)</SupportedImageTargetFrameworks>
    </PropertyGroup>

    <ItemGroup>
        <IkvmImageItem Include="ikvm\any\any\**\*" TargetFramework="any" RuntimeIdentifier="any" ImagePath="%(RecursiveDir)%(Filename)%(Extension)" Pack="true" PackagePath="ikvm\any\any\%(RecursiveDir)%(Filename)%(Extension)" />
        <IkvmImageItem Include="ikvm\any\$(ImageRuntimeIdentifier)\**\*" TargetFramework="any" RuntimeIdentifier="$(ImageRuntimeIdentifier)" ImagePath="%(RecursiveDir)%(Filename)%(Extension)" Pack="true" PackagePath="ikvm\any\$(ImageRuntimeIdentifier)\%(RecursiveDir)%(Filename)%(Extension)" />
        <IkvmImageItem Include="ikvm\net472\any\**\*" TargetFramework="net472" RuntimeIdentifier="any" ImagePath="%(RecursiveDir)%(Filename)%(Extension)" Pack="true" PackagePath="ikvm\net472\any\%(RecursiveDir)%(Filename)%(Extension)" />
        <IkvmImageItem Include="ikvm\net472\$(ImageRuntimeIdentifier)\**\*" TargetFramework="net472" RuntimeIdentifier="$(ImageRuntimeIdentifier)" ImagePath="%(RecursiveDir)%(Filename)%(Extension)" Pack="true" PackagePath="ikvm\net472\$(ImageRuntimeIdentifier)\%(RecursiveDir)%(Filename)%(Extension)" />
        <IkvmImageItem Include="ikvm\net6.0\any\**\*" TargetFramework="net6.0" RuntimeIdentifier="any" ImagePath="%(RecursiveDir)%(Filename)%(Extension)" Pack="true" PackagePath="ikvm\net6.0\any\%(RecursiveDir)%(Filename)%(Extension)" />
        <IkvmImageItem Include="ikvm\net6.0\$(ImageRuntimeIdentifier)\**\*" TargetFramework="net6.0" RuntimeIdentifier="$(ImageRuntimeIdentifier)" ImagePath="%(RecursiveDir)%(Filename)%(Extension)" Pack="true" PackagePath="ikvm\net6.0\$(ImageRuntimeIdentifier)\%(RecursiveDir)%(Filename)%(Extension)" />
    </ItemGroup>

    <ItemGroup>
        <PublishProjectReference Include="$(ImageBinProject)" Condition="$(SupportedImageTargetFrameworks.Contains('net472'))">
            <SetTargetFramework>TargetFramework=net472</SetTargetFramework>
            <SetRuntimeIdentifier>RuntimeIdentifier=$(ImageRuntimeIdentifier)</SetRuntimeIdentifier>
            <PublishItemGroup>PublishIkvmImageBinItem</PublishItemGroup>
            <PublishItemMetadata>TargetFramework=net472;RuntimeIdentifier=$(ImageRuntimeIdentifier)</PublishItemMetadata>
        </PublishProjectReference>
        <PublishProjectReference Include="$(ImageBinProject)" Condition="$(SupportedImageTargetFrameworks.Contains('net6.0'))">
            <SetTargetFramework>TargetFramework=net6.0</SetTargetFramework>
            <SetRuntimeIdentifier>RuntimeIdentifier=$(ImageRuntimeIdentifier)</SetRuntimeIdentifier>
            <PublishItemGroup>PublishIkvmImageBinItem</PublishItemGroup>
            <PublishItemMetadata>TargetFramework=net6.0;RuntimeIdentifier=$(ImageRuntimeIdentifier)</PublishItemMetadata>
        </PublishProjectReference>
    </ItemGroup>

    <Target Name="CollectIkvmImageBinItems" BeforeTargets="ExpandIkvmImageItems" DependsOnTargets="CollectPublishProjectReferenceItems;GetPublishProjectReferenceOutputItems">
        <ItemGroup>
            <IkvmImageItem Include="@(PublishIkvmImageBinItem)">
                <ImagePath>bin\%(PublishIkvmImageBinItem.PublishItemPath)</ImagePath>
                <PackagePath Condition=" '$([System.IO.Path]::GetExtension('%(PublishIkvmImageBinItem.PublishItemPath)'))' != '' ">ikvm\%(PublishIkvmImageBinItem.TargetFramework)\%(PublishIkvmImageBinItem.RuntimeIdentifier)\bin\%(PublishIkvmImageBinItem.PublishItemPath)</PackagePath>
                <PackagePath Condition=" '$([System.IO.Path]::GetExtension('%(PublishIkvmImageBinItem.PublishItemPath)'))' == '' ">$([System.IO.Path]::GetDirectoryName('ikvm\%(PublishIkvmImageBinItem.TargetFramework)\%(PublishIkvmImageBinItem.RuntimeIdentifier)\bin\%(PublishIkvmImageBinItem.PublishItemPath)'))</PackagePath>
                <Pack>true</Pack>
            </IkvmImageItem>
        </ItemGroup>
    </Target>

    <Import Project="buildTransitive\IKVM.Image.targets" />
    
</Project>
