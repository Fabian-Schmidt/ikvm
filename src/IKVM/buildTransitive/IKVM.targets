<Project>
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <PropertyGroup>
        <ResolveIkvmFrameworkReferencesDependsOn>
            $(ResolveIkvmFrameworkReferencesDependsOn);
            ResolveAssemblyReferences;
        </ResolveIkvmFrameworkReferencesDependsOn>
    </PropertyGroup>

    <!-- Gathers those references which are either related to the Framework itself, or IKVM. -->
    <Target Name="ResolveIkvmFrameworkReferences" DependsOnTargets="$(ResolveIkvmFrameworkReferencesDependsOn)">
        <ItemGroup Condition="$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'net461'))">
            <_IkvmFrameworkReference Include="@(ReferencePath)" Condition=" '%(ReferencePath.NuGetIsFrameworkReference)' == 'true' Or '%(ReferencePath.FrameworkFile)' == 'true' Or '%(ReferencePath.ResolvedFrom)' == '{TargetFrameworkDirectory}' "/>
        </ItemGroup>
        <ItemGroup Condition="$([MSBuild]::IsTargetFrameworkCompatible('$(TargetFramework)', 'netcoreapp3.1'))">
            <_IkvmFrameworkReference Include="@(ReferencePath)" Condition=" '%(ReferencePath.FrameworkReferenceName)' != '' Or '%(ReferencePath.FrameworkReferenceVersion)' != '' "/>
        </ItemGroup>
        <IkvmCanonicalizePath Items="@(_IkvmFrameworkReference)" MetadataName="Identity">
            <Output TaskParameter="Items" ItemName="IkvmFrameworkReference" />
        </IkvmCanonicalizePath>
    </Target>

    <!-- Transforms the IkvmReference item group into IkvmReferenceItem items. -->
    <Target Name="GetIkvmReferenceItemsFromIkvmReferences">
        <ItemGroup>
            <IkvmReferenceItem Include="@(IkvmReference)">

            </IkvmReferenceItem>
        </ItemGroup>
    </Target>

    <!-- Populates the IkvmReferenceItem set with required metadata. -->
    <Target Name="_UpdateIkvmReferenceItemsMetadata" DependsOnTargets="GetIkvmReferenceItemsFromIkvmReferences;ResolveIkvmRuntimeAssembly;ResolveIkvmBaseAssembly;ResolveIkvmFrameworkReferences" Condition=" '@(IkvmReferenceItem)' != '' ">
        <Error Text="Could not locate IKVM.Runtime assembly." Condition=" '$(IkvmRuntimeAssembly)' == '' " />
        <Error Text="IKVM.Runtime.dll could not be located at '$(IkvmRuntimeAssembly)'." Condition="!Exists('$(IkvmRuntimeAssembly)')" />
        <Error Text="Could not locate IKVM.Java assembly." Condition=" '$(IkvmBaseAssembly)' == '' " />
        <Error Text="IKVM.Java.dll could not be located at '$(IkvmBaseAssembly)'." Condition="!Exists('$(IkvmBaseAssembly)')" />

        <ItemGroup>
            <_IkvmReferenceReferences Include="$(IkvmRuntimeAssembly);$(IkvmRuntimeJNIAssembly);$(IkvmBaseAssembly)" />
            <_IkvmReferenceReferences Include="@(IkvmFrameworkReference)" />
        </ItemGroup>

        <!-- Populates metadata, validates, resolves references, and emits in build order. -->
        <IkvmReferenceItemPrepare Items="@(IkvmReferenceItem)" ToolVersion="$(IkvmVersion)" ToolFramework="$(IkvmToolFramework)" RuntimeAssembly="$(IkvmRuntimeAssembly)" References="@(_IkvmReferenceReferences)" StageDir="$(IkvmStageDir)" CacheDir="$(IkvmCacheDir)">
            <Output TaskParameter="Items" ItemName="_IkvmReferenceItemWithMetadata" />
        </IkvmReferenceItemPrepare>

        <!-- Assign newly discovered items. -->
        <ItemGroup>
            <IkvmReferenceItem Remove="@(IkvmReferenceItem)"/>
            <IkvmReferenceItem Include="@(_IkvmReferenceItemWithMetadata)" />
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <GetIkvmReferenceItemsDependsOn>
            $(GetIkvmReferenceItemsDependsOn);
            ResolveIkvmFrameworkReferences;
            GetIkvmReferenceItemsFromIkvmReferences;
            _UpdateIkvmReferenceItemsMetadata;
        </GetIkvmReferenceItemsDependsOn>
    </PropertyGroup>

    <!-- Assembles the set of IkvmReferenceItems from various sources. -->
    <Target Name="GetIkvmReferenceItems" DependsOnTargets="$(GetIkvmReferenceItemsDependsOn)" Returns="@(IkvmReferenceItem)">

    </Target>

    <!-- Builds the IkvmReferenceItem set into their output items within the cache. -->
    <Target Name="_CompileIkvmReferences" DependsOnTargets="ResolveIkvmRuntimeAssembly;ResolveIkvmBaseAssembly;ResolveIkvmFrameworkReferences" Inputs="%(IkvmReferenceItem.Compile)" Outputs="%(IkvmReferenceItem.CachePath)">
        <Error Text="_CompileIkvmReferences has no implementation." />
    </Target>

    <PropertyGroup>
        <CompileIkvmReferencesDependsOn>
            $(CompileIkvmReferenceAssemblies);
            GetIkvmReferenceItems;
            ResolveIkvmFrameworkReferences;
            _CompileIkvmReferences;
        </CompileIkvmReferencesDependsOn>
    </PropertyGroup>

    <Target Name="CompileIkvmReferences" DependsOnTargets="$(CompileIkvmReferencesDependsOn)">

    </Target>

    <!-- Adds the expected IkvmReferences to the Reference set. -->
    <Target Name="_ResolveIkvmReferences" DependsOnTargets="GetIkvmReferenceItems">
        <ItemGroup>
            <IkvmReferencePath Include="@(IkvmReferenceItem->'%(CachePath)')">
                <ReferenceSourceTarget>ResolveIkvmReferences</ReferenceSourceTarget>
                <HintPath>%(IkvmReferenceItem.CachePath)</HintPath>
                <Aliases>%(IkvmReferenceItem.Aliases)</Aliases>
                <Private>%(IkvmReferenceItem.Private)</Private>
                <CopyLocal>%(IkvmReferenceItem.CopyLocal)</CopyLocal>
                <ReferenceOutputAssembly>%(IkvmReferenceItem.ReferenceOutputAssembly)</ReferenceOutputAssembly>
                <JavaClasspath>%(IkvmReferenceItem.Compile)</JavaClasspath>
            </IkvmReferencePath>
            <ReferencePath Include="@(IkvmReferencePath)" />
            <ReferenceCopyLocalPaths Include="@(IkvmReferencePath)" />
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <ResolveIkvmReferencesDependsOn>
            $(ResolveIkvmReferencesDependsOn);
            CompileIkvmReferences;
            GetIkvmReferenceItems;
            _ResolveIkvmReferences;
        </ResolveIkvmReferencesDependsOn>
    </PropertyGroup>

    <Target Name="ResolveIkvmReferences" DependsOnTargets="$(ResolveIkvmReferencesDependsOn)">

    </Target>

    <!-- Ensure the IkvmReference assemblies are built before compile. -->
    <PropertyGroup Condition=" '$(TargetFramework)' != '' ">
        <ResolveReferencesDependsOn>
            ResolveIkvmReferences;
            $(ResolveReferencesDependsOn);
        </ResolveReferencesDependsOn>
    </PropertyGroup>

    <!-- Include Task or NoTask implementation of targets. -->
    <Import Project="IKVM.Tasks.targets" Condition=" '$(UseIkvmTasks)' != 'false' "/>
    <Import Project="IKVM.NoTasks.targets" Condition=" '$(UseIkvmTasks)' == 'false' "/>
</Project>
