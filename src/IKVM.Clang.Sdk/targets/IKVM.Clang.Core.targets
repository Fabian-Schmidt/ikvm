<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <PropertyGroup>
        <OutputType Condition=" '$(OutputType)' == '' ">library</OutputType>
        <OutputType>$(OutputType.ToLower())</OutputType>
    </PropertyGroup>

    <PropertyGroup>
        <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
        <PlatformName Condition=" '$(PlatformName)' == '' ">$(Platform)</PlatformName>
        <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
        <ConfigurationName Condition=" '$(ConfigurationName)' == '' ">$(Configuration)</ConfigurationName>

        <BaseOutputPath Condition=" '$(BaseOutputPath)' == '' ">bin\</BaseOutputPath>
        <BaseOutputPath Condition="!HasTrailingSlash('$(BaseOutputPath)')">$(BaseOutputPath)\</BaseOutputPath>
        <OutputPath Condition=" '$(OutputPath)' == '' ">$(BaseOutputPath)$(Configuration)\$(TargetMachine)\</OutputPath>
        <OutputPath Condition="!HasTrailingSlash('$(OutputPath)')">$(OutputPath)\</OutputPath>

        <BaseIntermediateOutputPath Condition="'$(BaseIntermediateOutputPath)' == ''">obj\</BaseIntermediateOutputPath>
        <BaseIntermediateOutputPath Condition="!HasTrailingSlash('$(BaseIntermediateOutputPath)')">$(BaseIntermediateOutputPath)\</BaseIntermediateOutputPath>
        <IntermediateOutputPath Condition=" '$(IntermediateOutputPath)' == '' ">$(BaseIntermediateOutputPath)$(Configuration)\$(TargetMachine)</IntermediateOutputPath>
        <IntermediateOutputPath Condition="!HasTrailingSlash('$(IntermediateOutputPath)')">$(IntermediateOutputPath)\</IntermediateOutputPath>
    </PropertyGroup>

    <PropertyGroup>
        <DebugSymbols Condition=" '$(ConfigurationName)' == 'Debug' and '$(DebugSymbols)' == '' and '$(DebugType)'==''">true</DebugSymbols>
    </PropertyGroup>

    <PropertyGroup>
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' "></TargetPrefix>
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' And '$(OutputType)' == 'library' And $(TargetMachine.Contains('-linux-')) ">lib</TargetPrefix>
        <TargetPrefix Condition=" '$(TargetPrefix)' == '' And '$(OutputType)' == 'library' And $(TargetMachine.Contains('-osx-')) ">lib</TargetPrefix>

        <TargetExt Condition=" '$(TargetPrefix)' == '' "></TargetExt>
        <TargetExt Condition=" '$(TargetExt)' == '' And '$(OutputType)' == 'exe' And $(TargetMachine.Contains('-windows-'))">.exe</TargetExt>
        <TargetExt Condition=" '$(TargetExt)' == '' And '$(OutputType)' == 'library' And $(TargetMachine.Contains('-windows-')) ">.dll</TargetExt>
        <TargetExt Condition=" '$(TargetExt)' == '' And '$(OutputType)' == 'library' And $(TargetMachine.Contains('-linux-')) ">.so</TargetExt>
        <TargetExt Condition=" '$(TargetExt)' == '' And '$(OutputType)' == 'library' And $(TargetMachine.Contains('-osx-')) ">.dylib</TargetExt>

        <DebugSymbolsExt Condition=" '$(DebugSymbolsExt)' == '' And $(TargetMachine.Contains('-windows-')) ">.pdb</DebugSymbolsExt>
        <DebugSymbolsExt Condition=" '$(DebugSymbolsExt)' == '' And $(TargetMachine.Contains('-linux-')) ">.g</DebugSymbolsExt>
        <DebugSymbolsExt Condition=" '$(DebugSymbolsExt)' == '' And $(TargetMachine.Contains('-osx-')) ">.g</DebugSymbolsExt>
    </PropertyGroup>

    <PropertyGroup>
        <ProjectName Condition=" '$(ProjectName)' == '' ">$(MSBuildProjectName)</ProjectName>
        <TargetName Condition=" '$(TargetName)' == '' ">$(ProjectName)</TargetName>
        <ProjectFileName Condition=" '$(ProjectFileName)' == '' ">$(MSBuildProjectFile)</ProjectFileName>
        <ProjectExt Condition=" '$(ProjectExt)' == '' ">$(MSBuildProjectExtension)</ProjectExt>

        <TargetFileName Condition=" '$(TargetFileName)' == '' ">$(TargetPrefix)$(TargetName)$(TargetExt)</TargetFileName>
        <DebugSymbolsFileName Condition=" '$(DebugSymbolsFileName)' == '' ">$(TargetPrefix)$(TargetName)$(DebugSymbolsExt)</DebugSymbolsFileName>

        <IntermediateTargetPath Condition=" '$(IntermediateTargetPath)' == '' ">$(IntermediateOutputPath)$(TargetFileName)</IntermediateTargetPath>
        <TargetPath Condition=" '$(TargetPath)' == '' ">$(OutputPath)$(TargetFileName)</TargetPath>

        <IntermediateDebugSymbolsPath Condition=" '$(IntermediateDebugSymbolsPath)' == '' ">$(IntermediateOutputPath)$(DebugSymbolsFileName)</IntermediateDebugSymbolsPath>
        <DebugSymbolsPath Condition=" '$(DebugSymbolsPath)' == '' ">$(OutputPath)$(DebugSymbolsFileName)</DebugSymbolsPath>

        <ClangResponseFileName Condition=" '$(ClangResponseFileName)' == '' ">$(TargetName).clang.rsp</ClangResponseFileName>
        <ClangResponseFile Condition=" '$(ClangResponseFile)' == '' ">$(IntermediateOutputPath)$(ClangResponseFileName)</ClangResponseFile>
    </PropertyGroup>

    <!--
    
    GetTargetItem
    
    Externally callable target that returns information about the target being built.
    
    -->

    <PropertyGroup>
        <GetTargetItemDependsOn>
            $(GetTargetItemDependsOn)
        </GetTargetItemDependsOn>
    </PropertyGroup>

    <Target Name="GetTargetItem" DependsOnTargets="$(GetTargetItemDependsOn)" Returns="@(TargetItem)">
        <ItemGroup>
            <TargetItem Include="$(IntermediateTargetPath)">
                <TargetName>$(TargetName)</TargetName>
                <TargetFileName>$(TargetFileName)</TargetFileName>
                <DebugSymbolsFileName>$(DebugSymbolsFileName)</DebugSymbolsFileName>
                <Version>$(Version)</Version>
            </TargetItem>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <PreBuildEventDependsOn></PreBuildEventDependsOn>
        <PostBuildEventDependsOn></PostBuildEventDependsOn>
    </PropertyGroup>

    <Target
        Name="PreBuildEvent"
        Condition="'$(PreBuildEvent)'!=''"
        DependsOnTargets="$(PreBuildEventDependsOn)">

        <Exec WorkingDirectory="$(OutDir)" Command="$(PreBuildEvent)" />
    </Target>

    <Target
        Name="PostBuildEvent"
        Condition="'$(PostBuildEvent)'!=''"
        DependsOnTargets="$(PostBuildEventDependsOn)">

        <Exec WorkingDirectory="$(OutDir)" Command="$(PostBuildEvent)" />
    </Target>

    <PropertyGroup>
        <BuildDependsOn>
            BeforeBuild;
            CoreBuild;
            AfterBuild
        </BuildDependsOn>
    </PropertyGroup>

    <Target Name="Build" Condition=" '$(_InvalidConfigurationWarning)' != 'true' " DependsOnTargets="$(BuildDependsOn)" Returns="@(TargetPath)" />

    <Target Name="BeforeBuild"/>

    <Target Name="AfterBuild"/>

    <PropertyGroup>
        <CoreBuildDependsOn>
            PreBuildEvent;
            Compile;
            GetTargetItem;
            PrepareForRun;
            PostBuildEvent
        </CoreBuildDependsOn>
    </PropertyGroup>

    <Target Name="CoreBuild" DependsOnTargets="$(CoreBuildDependsOn)">
        <OnError ExecuteTargets="_TimeStampAfterCompile;PostBuildEvent" Condition="'$(RunPostBuildEvent)'=='Always' or '$(RunPostBuildEvent)'=='OnOutputUpdated'"/>
    </Target>

    <PropertyGroup>
        <_ProjectDefaultTargets Condition="'$(MSBuildProjectDefaultTargets)' != ''">$(MSBuildProjectDefaultTargets)</_ProjectDefaultTargets>
        <_ProjectDefaultTargets Condition="'$(MSBuildProjectDefaultTargets)' == ''">Build</_ProjectDefaultTargets>

        <RebuildDependsOn>
            BeforeRebuild;
            Clean;
            $(_ProjectDefaultTargets);
            AfterRebuild;
        </RebuildDependsOn>

        <RebuildDependsOn Condition=" '$(MSBuildProjectDefaultTargets)' == 'Rebuild' " >
            BeforeRebuild;
            Clean;
            Build;
            AfterRebuild;
        </RebuildDependsOn>
    </PropertyGroup>

    <Target Name="Rebuild" Condition=" '$(_InvalidConfigurationWarning)' != 'true' " DependsOnTargets="$(RebuildDependsOn)" Returns="$(TargetPath)"/>

    <Target Name="BeforeRebuild"/>

    <Target Name="AfterRebuild"/>

    <PropertyGroup>
        <CompileDependsOn>
            BeforeCompile;
            BuildClangResponseFile;
            CoreCompile;
            AfterCompile;
        </CompileDependsOn>
    </PropertyGroup>

    <Target Name="Compile" DependsOnTargets="$(CompileDependsOn)"/>

    <Target Name="BeforeCompile" />

    <Target Name="AfterCompile" />
    
    <!-- 
    
    BuildClangResponseFile
    
    Assembles a file that contains the arguments to be passed to clang.
    
    -->

    <Target Name="BuildClangResponseFile">
        <MakeDir Directories="$(IntermediateOutputPath)" />
        
        <ItemGroup>
            <_Lines Remove="@(_Lines)" />
            <_Lines Include="-v" Condition=" '$(Verbose)' == 'true' " />
            <_Lines Include="--target=$(TargetMachine)" />
            <_Lines Include="-shared" Condition=" '$(OutputType)' == 'library' " />
            <_Lines Include="-fuse-ld=$(UseLd)" Condition=" '$(UseLd)' != '' " />
            <_Lines Include="-std=$(LanguageStandard)" Condition=" '$(LanguageStandard)' != '' " />
            <_Lines Include="-fms-compatibility" Condition=" '$(MsCompatibility)' == 'true' " />
            <_Lines Include="-g" Condition=" '$(DebugSymbols)' == 'true' " />

            <_SystemIncludeDirectories Include="@(SystemIncludeDirectories)" />
            <_SystemIncludeDirectories Include="$(SystemIncludeDirectories)" />
            <_Lines Include="@(_SystemIncludeDirectories->'-isystem &quot;%(FullPath)&quot;'->Replace('\', '\\'))" Condition=" '@(_SystemIncludeDirectories)' != '' " />

            <_IncludeDirectories Include="@(IncludeDirectories)" />
            <_IncludeDirectories Include="$(IncludeDirectories)" />
            <_Lines Include="@(_IncludeDirectories->'-I &quot;%(FullPath)&quot;'->Replace('\', '\\'))" Condition=" '@(_IncludeDirectories)' != '' " />

            <_DependencyDirectories Include="@(DependencyDirectories)" />
            <_DependencyDirectories Include="$(DependencyDirectories)" />
            <_Lines Include="@(_DependencyDirectories->'-L &quot;%(FullPath)&quot;'->Replace('\', '\\'))" Condition=" '@(_DependencyDirectories)' != '' " />

            <_Dependencies Include="@(Dependencies)" />
            <_Dependencies Include="$(Dependencies)" />
            <_Lines Include="@(_Dependencies->'-l &quot;%(Identity)&quot;'->Replace('\', '\\'))" Condition=" '@(_Dependencies)' != '' " />

            <_PreprocessorDefinitions Include="$(PreprocessorDefinitions)" />
            <_Lines Include="@(_PreprocessorDefinitions->'-D &quot;%(Identity)&quot;')" Condition=" '@(_PreprocessorDefinitions)' != '' " />

            <_Lines Include="$(AdditionalOptions)" Condition=" '$(AdditionalOptions)' != '' " />
            <_Lines Include="@(AdditionalOptions->'&quot;%(Identity)&quot;')" Condition=" '@(AdditionalOptions)' != '' " />

            <_Lines Include="@(Compile->'&quot;%(FullPath)&quot;'->Replace('\', '\\'))" />

            <_Lines Include="-o &quot;$(IntermediateTargetPath.Replace('\', '\\'))&quot;" />
        </ItemGroup>
        <WriteLinesToFile File="$(ClangResponseFile)" Lines="@(_Lines)" Overwrite="true" WriteOnlyWhenDifferent="true" />
    </Target>
    
    <!--
    
    CoreCompile
    
    Executes clang.
    
    -->

    <Target Name="CoreCompile" DependsOnTargets="BuildClangResponseFile" Inputs="$(ClangResponseFile)" Outputs="$(IntermediateTargetPath)">
        <Exec Command="clang @$(ClangResponseFile)" />
    </Target>

    <PropertyGroup>
        <CopyFilesToOutputDirectoryDependsOn>
            Compile;
        </CopyFilesToOutputDirectoryDependsOn>
    </PropertyGroup>

    <Target Name="CopyFilesToOutputDirectory" DependsOnTargets="$(CopyFilesToOutputDirectoryDependsOn)">
        <PropertyGroup>
            <CreateHardLinksForCopyFilesToOutputDirectoryIfPossible Condition="'$(BuildingInsideVisualStudio)' == 'true' or '$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)' == ''">false</CreateHardLinksForCopyFilesToOutputDirectoryIfPossible>
            <CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible Condition="'$(BuildingInsideVisualStudio)' == 'true' or '$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)' == ''">false</CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible>
            <ErrorIfLinkFailsForCopyFilesToOutputDirectory Condition="'$(BuildingInsideVisualStudio)' == 'true' or '$(ErrorIfLinkFailsForCopyFilesToOutputDirectory)' == ''">false</ErrorIfLinkFailsForCopyFilesToOutputDirectory>
        </PropertyGroup>

        <PropertyGroup>
            <CopyTargetToOutputDirectory Condition=" '$(CopyTargetToOutputDirectory)' == '' ">true</CopyTargetToOutputDirectory>
            <CopyDebugSymbolsToOutputDirectory Condition=" '$(CopyDebugSymbolsToOutputDirectory)' == '' ">true</CopyDebugSymbolsToOutputDirectory>
        </PropertyGroup>

        <Copy
            SourceFiles="$(IntermediateTargetPath)"
            DestinationFiles="$(TargetPath)"
            SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
            OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
            Retries="$(CopyRetryCount)"
            RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
            UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
            UseSymboliclinksIfPossible="$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)"
            ErrorIfLinkFails="$(ErrorIfLinkFailsForCopyFilesToOutputDirectory)"
            Condition="'$(CopyTargetToOutputDirectory)' == 'true' and '$(SkipCopyBuildProduct)' != 'true'">
            <Output TaskParameter="DestinationFiles" ItemName="MainAssembly"/>
            <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>
        </Copy>

        <Copy
            SourceFiles="$(IntermediateDebugSymbolsPath)"
            DestinationFiles="$(DebugSymbolsPath)"
            SkipUnchangedFiles="$(SkipCopyUnchangedFiles)"
            OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
            Retries="$(CopyRetryCount)"
            RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
            UseHardlinksIfPossible="$(CreateHardLinksForCopyFilesToOutputDirectoryIfPossible)"
            UseSymboliclinksIfPossible="$(CreateSymbolicLinksForCopyFilesToOutputDirectoryIfPossible)"
            ErrorIfLinkFails="$(ErrorIfLinkFailsForCopyFilesToOutputDirectory)"
            Condition="'$(CopyDebugSymbolsToOutputDirectory)' == 'true' and '$(SkipCopyBuildProduct)' != 'true'">
            <Output TaskParameter="DestinationFiles" ItemName="MainAssembly"/>
            <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>
        </Copy>

    </Target>

    <PropertyGroup>
        <PrepareForRunDependsOn>
            CopyFilesToOutputDirectory
        </PrepareForRunDependsOn>
    </PropertyGroup>

    <Target Name="PrepareForRun" DependsOnTargets="$(PrepareForRunDependsOn)">
        
    </Target>

</Project>
